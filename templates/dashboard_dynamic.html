<!DOCTYPE html>
<html>

<head>
    <title>Dashboard â€“ Vital Monitoring</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">Smart Care</div>

            <div class="welcome">
                <div class="welcome-bg">
                    <p>{{ user.greeting }}</p>
                    <h3>{{ user.name }}</h3>
                    <p style="font-size:12px; opacity:0.9; margin-top:5px;">
                        {% if user.role == 'hospital' %}
                        ğŸ‘¨â€âš•ï¸ Medical Professional
                        {% else %}
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Portal
                        {% endif %}
                    </p>
                </div>
            </div>

            <nav class="menu">
                <a class="active">ğŸ“Š Dashboard</a>
                <a>ğŸ‘¥ Patients</a>
                {% if user.role == 'hospital' %}
                <a>ğŸ“… Calendar</a>
                <a>ğŸ“‹ Reports</a>
                <a>âš™ï¸ Settings</a>
                {% else %}
                <a>ğŸ”” Alerts</a>
                <a>ğŸ“ Contact Doctor</a>
                {% endif %}
                <a>â“ Support</a>
            </nav>

            <a href="/logout" class="logout-side">ğŸšª Log Out</a>
        </aside>

        <!-- Main -->
        <main class="main">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="search">
                    ğŸ” <input type="text" placeholder="Search patients here ...">
                </div>
                <div class="top-right">
                    <span class="notification-badge">ğŸ””</span>
                    <span class="user">{{ user.name }} âŒ„</span>
                    <a href="/logout" class="logout-icon">â‹</a>
                </div>
            </div>

            <!-- Content -->
            <section class="content">
                <!-- Hospital/Doctor View -->
                {% if user.role == 'hospital' %}
                <div class="section-header">
                    <h2>Patient Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <a href="/simulate_data" style="text-decoration: none;">
                            <button class="add-btn" style="background: linear-gradient(135deg, #2196F3, #1976D2);">ğŸ²
                                Generate Random Data</button>
                        </a>
                        <button class="add-btn" onclick="toggleAddForm()">â• Add New Patient</button>
                    </div>
                </div>

                <div id="addPatientForm" class="add-patient-form"
                    style="display:none; background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <h3>Add New Patient & Emergency Contacts</h3>
                    <form method="POST" action="/add_patient">
                        <div class="form-row"
                            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <input type="text" name="name" placeholder="Patient Name" required>
                            <input type="number" name="age" placeholder="Age" required>
                            <select name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div class="contact-box"
                                style="background:#fff; padding:15px; border-radius:8px; border: 1px solid #eee;">
                                <h4 style="margin-bottom:10px; color:#2196F3;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family Contact</h4>
                                <input type="email" name="family_email" placeholder="Family Email"
                                    style="width:100%; margin-bottom:10px;">
                                <input type="text" name="family_phone" placeholder="Family Phone" style="width:100%;">
                            </div>
                            <div class="contact-box"
                                style="background:#fff; padding:15px; border-radius:8px; border: 1px solid #eee;">
                                <h4 style="margin-bottom:10px; color:#4CAF50;">ğŸ©º Doctor Contact</h4>
                                <input type="email" name="doctor_email" placeholder="Doctor Email"
                                    style="width:100%; margin-bottom:10px;">
                                <input type="text" name="doctor_phone" placeholder="Doctor Phone" style="width:100%;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="submit" class="submit-btn" style="background: #2196F3;">Save Patient
                                Details</button>
                            <button type="button" class="cancel-btn" onclick="toggleAddForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <h4>Total Patients</h4>
                        <p class="stat-number" id="totalPatients">0</p>
                    </div>
                    <div class="stat-card danger-stat">
                        <h4>Critical Alerts</h4>
                        <p class="stat-number" id="criticalCount">0</p>
                    </div>
                    <div class="stat-card safe-stat">
                        <h4>Stable Patients</h4>
                        <p class="stat-number" id="stableCount">0</p>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px 0;">All Patients - Real-time Monitoring</h3>
                <div class="patients-grid" id="patientsGrid"></div>

                <!-- Family/Home View -->
                {% else %}
                <div class="family-header">
                    <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Health Monitor</h2>
                    <p>Monitor your loved ones' vital signs in real-time</p>
                </div>

                <div class="alert-banner" id="alertBanner" style="display:none;">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-text">CRITICAL: One or more patients need immediate attention!</span>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <h4>Monitored Patients</h4>
                        <p class="stat-number" id="totalPatients">0</p>
                    </div>
                    <div class="stat-card danger-stat">
                        <h4>âš ï¸ Need Attention</h4>
                        <p class="stat-number" id="criticalCount">0</p>
                    </div>
                    <div class="stat-card safe-stat">
                        <h4>âœ… All Good</h4>
                        <p class="stat-number" id="stableCount">0</p>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px 0;">Patient Vital Signs</h3>
                <div class="patients-grid" id="patientsGrid"></div>

                <div class="info-section">
                    <h4>ğŸ“‹ Understanding Vital Signs</h4>
                    <div class="info-grid">
                        <div class="info-card">
                            <strong>ğŸ’“ Pulse Rate</strong>
                            <p>Normal: 60-110 bpm</p>
                        </div>
                        <div class="info-card">
                            <strong>ğŸ« SpOâ‚‚ (Oxygen)</strong>
                            <p>Normal: 90% or above</p>
                        </div>
                        <div class="info-card">
                            <strong>ğŸŒ¡ï¸ Temperature</strong>
                            <p>Normal: 35-38Â°C</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Charts Section (for Hospital only) -->
                {% if user.role == 'hospital' %}
                <div class="charts-row">
                    <div class="bar-chart">
                        <h4>Systolic Analysis</h4>
                        <div class="bars">
                            <div><span style="height:20%"></span>
                                <p>0-89</p>
                            </div>
                            <div><span style="height:35%"></span>
                                <p>90-119</p>
                            </div>
                            <div><span style="height:53%"></span>
                                <p>140-159</p>
                            </div>
                            <div><span style="height:30%"></span>
                                <p>150+</p>
                            </div>
                        </div>
                    </div>

                    <div class="ecg">
                        <h4>ECG Data</h4>
                        <div class="ecg-box">[ Live ECG Area ]</div>
                    </div>
                </div>
                {% endif %}
            </section>
        </main>
    </div>

    <audio id="beep" loop>
        <source src="/static/alert.mp3" type="audio/mpeg">
    </audio>

    <!-- AI Report Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">AI Health Report</h2>
            <div id="summaryText"
                style="white-space: pre-wrap; margin: 20px 0; line-height: 1.6; text-align: left; font-size: 15px; color: #333;">
                Loading AI intelligence ...
            </div>

            <!-- Video Suggestion Section -->
            <div id="videoSection" style="display:none; margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px;">
                <h4 style="color: #f44336; margin-bottom: 10px;">ğŸ†˜ Guidance Video: What to do now</h4>
                <div
                    style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; border: 1px solid #eee;">
                    <iframe id="videoEmbed"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" src=""
                        title="Emergency Guidance"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
            </div>
            <a id="downloadBtn" href="#" class="add-btn"
                style="background: #2196F3; text-decoration: none; display: inline-block;">ğŸ“¥ Download PDF Report</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const userRole = "{{ user.role }}";
        const charts = {};

        function toggleAddForm() {
            const form = document.getElementById("addPatientForm");
            form.style.display = form.style.display === "none" ? "block" : "none";
        }

        function showSummary(pid, name) {
            const modal = document.getElementById("summaryModal");
            const text = document.getElementById("summaryText");
            const downloadBtn = document.getElementById("downloadBtn");
            const videoSection = document.getElementById("videoSection");
            const videoEmbed = document.getElementById("videoEmbed");

            document.getElementById("modalTitle").innerText = `AI Health Analysis: ${name}`;
            text.innerText = "Analyzing vital patterns and generating health summary ...";
            videoSection.style.display = "none";
            videoEmbed.src = "";
            modal.style.display = "block";

            fetch(`/get_summary/${pid}`)
                .then(r => r.json())
                .then(data => {
                    text.innerText = data.summary;
                    downloadBtn.href = `/download_report/${pid}`;

                    if (data.video_url) {
                        videoEmbed.src = data.video_url;
                        videoSection.style.display = "block";
                    }
                });
        }

        function closeModal() {
            document.getElementById("summaryModal").style.display = "none";
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById("summaryModal");
            if (event.target == modal) closeModal();
        }

        function initChart(pid, ctx) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Heart Rate',
                        borderColor: '#ff6b6b',
                        data: [],
                        tension: 0.3
                    }, {
                        label: 'SpO2',
                        borderColor: '#4facfe',
                        data: [],
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(pid) {
            fetch(`/vitals/${pid}`)
                .then(r => r.json())
                .then(data => {
                    const chart = charts[pid];
                    if (!chart) return;

                    chart.data.labels = data.map(d => d.timestamp);
                    chart.data.datasets[0].data = data.map(d => d.heart_rate);
                    chart.data.datasets[1].data = data.map(d => d.spo2);
                    chart.update();
                });
        }

        function loadPatients() {
            fetch("/get_patients")
                .then(r => r.json())
                .then(data => {
                    const grid = document.getElementById("patientsGrid");
                    const currentPids = data.map(p => p.id);

                    // Clean up charts for deleted patients
                    Object.keys(charts).forEach(pid => {
                        if (!currentPids.includes(parseInt(pid))) {
                            charts[pid].destroy();
                            delete charts[pid];
                        }
                    });

                    let dangerCount = 0;
                    let safeCount = 0;

                    data.forEach(p => {
                        if (p.danger) {
                            dangerCount++;
                        } else {
                            safeCount++;
                        }

                        let cardId = `patient-card-${p.id}`;
                        let card = document.getElementById(cardId);

                        if (!card) {
                            // Create card if it doesn't exist
                            const div = document.createElement('div');
                            div.id = cardId;
                            grid.appendChild(div);
                            card = div;
                        }

                        const statusClass = p.status.toLowerCase(); // normal, warning, critical

                        if (userRole === "hospital") {
                            card.className = `patient-card ${statusClass}`;
                            card.innerHTML = `
                                <div class="patient-card-header">
                                    <h4>${p.name}</h4>
                                    <div style="display: flex; gap: 5px;">
                                        <button onclick="showSummary(${p.id}, '${p.name}')" class="view-btn" style="padding: 2px 5px; font-size: 10px; background: #9c27b0; color: white;">ğŸ“„ Report</button>
                                        <a href="/simulate_data" class="view-btn" style="padding: 2px 5px; font-size: 10px; background: #eee;">Sim</a>
                                        <a href="/delete_patient/${p.id}" class="delete-btn" onclick="return confirm('Delete ${p.name}?')">ğŸ—‘ï¸</a>
                                    </div>
                                </div>
                                <div class="patient-info">
                                    <p><strong>Age:</strong> ${p.age} | <strong>Gender:</strong> ${p.gender}</p>
                                </div>
                                <div class="vitals-display">
                                    <div class="vital-item">
                                        <span class="vital-icon">ğŸ’“</span>
                                        <div><small>Pulse</small><strong>${p.Pulse} bpm</strong></div>
                                    </div>
                                    <div class="vital-item">
                                        <span class="vital-icon">ğŸ«</span>
                                        <div><small>SpOâ‚‚</small><strong>${p.SpO2}%</strong></div>
                                    </div>
                                    <div class="vital-item">
                                        <span class="vital-icon">ğŸŒ¡ï¸</span>
                                        <div><small>Temp</small><strong>${p.Temperature}Â°C</strong></div>
                                    </div>
                                </div>
                                <div style="height: 80px; margin-top: 10px;">
                                    <canvas id="chart-${p.id}"></canvas>
                                </div>
                                <div class="${statusClass}-badge" style="text-align: center; margin-top: 10px; font-weight: bold; padding: 5px; border-radius: 10px;">
                                    ${p.status.toUpperCase()}
                                </div>
                                ${p.video_url ? `
                                <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                                    <small style="color: #f44336; font-weight: bold; display: block; margin-bottom: 5px;">Guidance Video</small>
                                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 5px;">
                                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" 
                                            src="${p.video_url}" title="Emergency Guidance" allowfullscreen></iframe>
                                    </div>
                                </div>` : ''}
                            `;
                        } else {
                            card.className = `patient-card-family ${statusClass}`;
                            card.innerHTML = `
                                <div class="patient-card-header">
                                    <h3>${p.name}</h3>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <button onclick="showSummary(${p.id}, '${p.name}')" class="view-btn" style="padding: 5px 10px; background: #9c27b0; color: white; border-radius: 20px;">ğŸ“„ Full AI Report</button>
                                        <span class="status-badge ${statusClass}-badge">${p.status.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="patient-info">
                                    <p>Age: ${p.age} years | ${p.gender}</p>
                                </div>
                                <div class="vitals-display-large">
                                    <div class="vital-box ${p.Pulse < 60 || p.Pulse > 100 ? 'vital-danger' : ''}">
                                        <span class="vital-icon-large">ğŸ’“</span>
                                        <div class="vital-details"><small>Heart Rate</small><h2>${p.Pulse}</h2><small>bpm</small></div>
                                    </div>
                                    <div class="vital-box ${p.SpO2 < 94 ? 'vital-danger' : ''}">
                                        <span class="vital-icon-large">ğŸ«</span>
                                        <div class="vital-details"><small>Oxygen Level</small><h2>${p.SpO2}</h2><small>%</small></div>
                                    </div>
                                    <div class="vital-box ${p.Temperature > 38 ? 'vital-danger' : ''}">
                                        <span class="vital-icon-large">ğŸŒ¡ï¸</span>
                                        <div class="vital-details"><small>Temperature</small><h2>${p.Temperature}</h2><small>Â°C</small></div>
                                    </div>
                                </div>
                                <div style="height: 100px; margin-top: 15px;">
                                    <canvas id="chart-${p.id}"></canvas>
                                </div>
                                ${p.video_url ? `
                                <div style="margin-top: 15px; background: #fff5f5; border: 2px solid #f44336; border-radius: 12px; padding: 15px;">
                                    <h4 style="color: #f44336; margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">
                                        <span>ğŸ†˜</span> FIRST-AID GUIDANCE
                                    </h4>
                                    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">Watch this video immediately for emergency instructions.</p>
                                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" 
                                            src="${p.video_url}" title="Emergency Guidance" allowfullscreen></iframe>
                                    </div>
                                </div>` : ''}
                            `;
                        }

                        // Initialize or update chart
                        const ctx = document.getElementById(`chart-${p.id}`);
                        if (ctx && !charts[p.id]) {
                            charts[p.id] = initChart(p.id, ctx);
                        }
                        updateChart(p.id);
                    });

                    // Update stats
                    document.querySelectorAll("#totalPatients").forEach(el => el.innerText = data.length);
                    document.querySelectorAll("#criticalCount").forEach(el => el.innerText = dangerCount);
                    document.querySelectorAll("#stableCount").forEach(el => el.innerText = safeCount);

                    // Show alert banner for family view
                    const alertBanner = document.getElementById("alertBanner");
                    if (alertBanner) {
                        alertBanner.style.display = dangerCount > 0 ? "flex" : "none";
                    }

                    // Audio alert (optional, can be annoying)
                    const beep = document.getElementById("beep");
                    if (beep && dangerCount > 0) {
                        beep.play().catch(e => { }); // Handle auto-play block
                    } else if (beep) {
                        beep.pause();
                    }
                });
        }

        setInterval(loadPatients, 3000);
        loadPatients();
    </script>

</body>

</html>